# 网络对战游戏架构文档

## 系统架构

本项目采用前后端分离架构，支持两个玩家进行实时对战。

```
┌─────────────────┐         WebSocket          ┌─────────────────┐
│                 │ ◄─────────────────────────► │                 │
│  前端客户端 1    │                             │   后端服务器     │
│  (进攻方/防守方) │ ◄─────────────────────────► │   (Node.js)     │
│                 │         WebSocket          │                 │
└─────────────────┘                             └─────────────────┘
                                                        ▲
                                                        │
                                                        │ WebSocket
                                                        │
┌─────────────────┐                                     │
│                 │                                     │
│  前端客户端 2    │ ◄───────────────────────────────────┘
│  (进攻方/防守方) │
│                 │
└─────────────────┘
```

## 核心模块

### 后端模块

#### 1. GameServer (游戏服务器)
- **职责**: 管理 WebSocket 连接，处理客户端消息
- **文件**: `backend/src/services/GameServer.ts`
- **主要功能**:
  - 接收并解析客户端消息
  - 路由消息到对应的处理器
  - 广播游戏状态到所有客户端
  - 管理游戏循环（60 FPS）

#### 2. GameRoomManager (房间管理器)
- **职责**: 管理游戏房间的创建、加入、离开
- **文件**: `backend/src/services/GameRoomManager.ts`
- **主要功能**:
  - 创建游戏房间
  - 玩家加入/离开房间
  - 房间列表查询
  - 玩家准备状态管理

#### 3. GameEngine (游戏引擎)
- **职责**: 处理游戏核心逻辑
- **文件**: `backend/src/services/GameEngine.ts`
- **主要功能**:
  - 车辆生成和移动
  - 防卫单位放置、升级、出售
  - 攻击和碰撞检测
  - 特殊效果（减速、溅射）
  - 胜负判定

### 数据模型

#### 玩家角色
```typescript
enum PlayerRole {
  ATTACKER,  // 进攻方
  DEFENDER   // 防守方
}
```

#### 车辆类型
```typescript
enum VehicleType {
  MOTORCYCLE_WITH_PERMIT,      // 有证摩托车
  MOTORCYCLE_WITHOUT_PERMIT,   // 无证摩托车
  ELECTRIC_MOTORCYCLE,         // 电摩
  ELECTRIC_BIKE               // 电动自行车
}
```

#### 车道类型
```typescript
enum LaneType {
  MAIN_ROAD,      // 主道
  AUXILIARY_ROAD, // 辅道
  NON_MOTORIZED   // 非机动车道
}
```

#### 防卫单位类型
```typescript
enum DefenseUnitType {
  AUXILIARY,  // 辅警
  TRAFFIC,    // 交警
  PATROL,     // 铁骑
  SWAT        // 特警
}
```

## 游戏流程

### 1. 房间创建与加入
```
客户端1 ──[CREATE_ROOM]──► 服务器
                           │
                           ├─ 创建房间
                           ├─ 分配玩家ID
                           └─► 返回房间ID

客户端2 ──[JOIN_ROOM]──► 服务器
                         │
                         ├─ 验证房间
                         ├─ 检查角色
                         └─► 返回玩家ID
```

### 2. 准备阶段
```
客户端 ──[PLAYER_READY]──► 服务器
                           │
                           ├─ 更新准备状态
                           └─► 广播状态

当所有玩家准备好:
  服务器 ──[GAME_START]──► 所有客户端
         │
         └─ 启动游戏循环 (60 FPS)
```

### 3. 游戏进行
```
进攻方 ──[SPAWN_VEHICLE]──► 服务器
                            │
                            ├─ 验证预算
                            ├─ 创建车辆
                            └─► 广播状态

防守方 ──[PLACE_DEFENSE]──► 服务器
                            │
                            ├─ 验证预算和位置
                            ├─ 创建防卫单位
                            └─► 广播状态

游戏循环（每帧）:
  ├─ 更新车辆位置
  ├─ 防卫单位寻找目标并攻击
  ├─ 更新投射物
  ├─ 碰撞检测和伤害计算
  ├─ 检查游戏结束条件
  └─► 广播状态 [GAME_STATE_UPDATE]
```

### 4. 游戏结束
```
服务器检测到胜利条件:
  ├─ 停止游戏循环
  └─► 广播 [GAME_OVER] 到所有客户端
```

## 网络协议

### 消息格式
所有消息使用 JSON 格式，包含以下基础字段：
```json
{
  "type": "消息类型",
  "timestamp": 1234567890
}
```

### 主要消息类型

| 消息类型 | 方向 | 说明 |
|---------|------|------|
| CREATE_ROOM | C→S | 创建游戏房间 |
| JOIN_ROOM | C→S | 加入游戏房间 |
| PLAYER_READY | C→S | 玩家准备 |
| GAME_START | S→C | 游戏开始 |
| SPAWN_VEHICLE | C→S | 派出车辆 |
| PLACE_DEFENSE | C→S | 放置防卫单位 |
| UPGRADE_DEFENSE | C→S | 升级防卫单位 |
| SELL_DEFENSE | C→S | 出售防卫单位 |
| GAME_STATE_UPDATE | S→C | 游戏状态更新 |
| GAME_OVER | S→C | 游戏结束 |
| ERROR | S→C | 错误消息 |

## 游戏平衡性设计

### 车辆与车道组合策略

| 车辆 | 推荐车道 | 优势 | 劣势 |
|------|---------|------|------|
| 有证摩托车 | 主道 | 速度最快 | 最容易被击中 |
| 无证摩托车 | 辅道 | 平衡型 | 无明显优势 |
| 电摩 | 辅道/非机动车道 | 较难被击中 | 速度较慢 |
| 电动自行车 | 非机动车道 | 最难被击中 | 速度最慢 |

### 防卫单位部署策略

| 单位 | 推荐位置 | 目标 | 协同 |
|------|---------|------|------|
| 辅警 | 路径起点 | 快速车辆 | 配合交警减速 |
| 交警 | 路径中段 | 所有车辆 | 为其他单位争取时间 |
| 铁骑 | 路径拐角 | 密集车辆 | 范围伤害 |
| 特警 | 路径终点 | 高血量车辆 | 最后防线 |

## 性能优化

### 服务器端
- 使用对象池减少内存分配
- 空间分区优化碰撞检测
- 差量状态同步减少网络流量

### 客户端
- Canvas 渲染优化
- 对象复用
- 离屏渲染

## 扩展性设计

### 支持更多玩家模式
当前架构支持 1v1，可以扩展为：
- 2v2（两个进攻方 vs 两个防守方）
- 团队模式（多人协作）

### 支持更多地图
- 定义地图配置文件
- 支持自定义路径
- 支持不同地形效果

### 支持更多单位
- 插件化单位系统
- 自定义技能系统
- 单位组合技

## 安全考虑

### 客户端验证
- 所有操作在服务器端验证
- 预算检查
- 位置合法性检查
- 操作权限检查

### 防作弊
- 服务器权威
- 操作频率限制
- 异常行为检测

## 调试工具

### 日志系统
服务器端输出详细日志：
```
[GameServer] 新客户端连接
[GameRoomManager] 房间 xxx 已创建
[GameEngine] 派出车辆: 有证摩托车 在 主道
[GameEngine] 放置单位: 辅警 在 (5, 3)
```

### 开发模式
- 热重载（tsx watch）
- TypeScript 类型检查
- 源码映射（Source Maps）

## 部署建议

### 开发环境
```bash
# 后端
cd backend
npm run dev

# 前端
npm run dev
```

### 生产环境
```bash
# 后端
cd backend
npm run build
npm start

# 前端
npm run build
# 使用 nginx 或其他静态服务器托管 dist 目录
```

### Docker 部署
```dockerfile
# 后端 Dockerfile
FROM node:18-alpine
WORKDIR /app
COPY backend/package*.json ./
RUN npm ci --production
COPY backend/dist ./dist
CMD ["node", "dist/index.js"]
```

## 未来规划

### Phase 1 - 前端集成（当前任务）
- [ ] PhaserJS 游戏框架集成
- [ ] WebSocket 客户端实现
- [ ] UI/UX 设计
- [ ] 匹配大厅系统

### Phase 2 - 功能增强
- [ ] 玩家账号系统
- [ ] 排行榜
- [ ] 回放系统
- [ ] 聊天功能

### Phase 3 - 内容扩展
- [ ] 更多车辆类型
- [ ] 更多防卫单位
- [ ] 更多地图
- [ ] 成就系统

### Phase 4 - 优化
- [ ] 服务器集群
- [ ] 负载均衡
- [ ] CDN 加速
- [ ] 数据库持久化
