<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œå¯¹æˆ˜æ¸¸æˆ - æµ‹è¯•å®¢æˆ·ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status {
            padding: 15px;
            background: white;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 600;
            color: #555;
        }

        .status-value {
            color: #667eea;
            font-weight: 600;
        }

        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.info {
            color: #4ec9b0;
        }

        .log-entry.error {
            color: #f48771;
        }

        .log-entry.success {
            color: #b5cea8;
        }

        .connected {
            color: #48bb78;
        }

        .disconnected {
            color: #f56565;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¦ æ‘©æ³•äº¤é€šå«å£« - ç½‘ç»œå¯¹æˆ˜æµ‹è¯•</h1>
        <p class="subtitle">Network Battle Game Test Client</p>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="section">
            <h2>ğŸ“¡ è¿æ¥çŠ¶æ€</h2>
            <div class="status">
                <div class="status-item">
                    <span class="status-label">æœåŠ¡å™¨åœ°å€:</span>
                    <span class="status-value">ws://localhost:8080</span>
                </div>
                <div class="status-item">
                    <span class="status-label">è¿æ¥çŠ¶æ€:</span>
                    <span id="connectionStatus" class="status-value disconnected">æœªè¿æ¥</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æˆ¿é—´ID:</span>
                    <span id="roomId" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ç©å®¶ID:</span>
                    <span id="playerId" class="status-value">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">è§’è‰²:</span>
                    <span id="role" class="status-value">-</span>
                </div>
            </div>
            <div class="controls">
                <button id="connectBtn">è¿æ¥æœåŠ¡å™¨</button>
                <button id="disconnectBtn" disabled>æ–­å¼€è¿æ¥</button>
            </div>
        </div>

        <!-- æˆ¿é—´æ“ä½œ -->
        <div class="section">
            <h2>ğŸ  æˆ¿é—´æ“ä½œ</h2>
            <div class="grid">
                <div>
                    <p style="margin-bottom: 10px; color: #555; font-weight: 600;">åˆ›å»ºæˆ¿é—´</p>
                    <input type="text" id="playerName1" placeholder="ç©å®¶åç§°" value="æµ‹è¯•ç©å®¶1">
                    <div class="controls" style="margin-top: 10px;">
                        <button id="createAttackerBtn" disabled>åˆ›å»ºæˆ¿é—´ï¼ˆè¿›æ”»æ–¹ï¼‰</button>
                        <button id="createDefenderBtn" disabled>åˆ›å»ºæˆ¿é—´ï¼ˆé˜²å®ˆæ–¹ï¼‰</button>
                    </div>
                </div>
                <div>
                    <p style="margin-bottom: 10px; color: #555; font-weight: 600;">åŠ å…¥æˆ¿é—´</p>
                    <input type="text" id="joinRoomId" placeholder="æˆ¿é—´ID">
                    <input type="text" id="playerName2" placeholder="ç©å®¶åç§°" value="æµ‹è¯•ç©å®¶2" style="margin-top: 10px;">
                    <div class="controls" style="margin-top: 10px;">
                        <button id="joinAttackerBtn" disabled>åŠ å…¥ï¼ˆè¿›æ”»æ–¹ï¼‰</button>
                        <button id="joinDefenderBtn" disabled>åŠ å…¥ï¼ˆé˜²å®ˆæ–¹ï¼‰</button>
                    </div>
                </div>
            </div>
            <div class="controls" style="margin-top: 15px;">
                <button id="readyBtn" disabled>å‡†å¤‡</button>
                <button id="leaveBtn" disabled>ç¦»å¼€æˆ¿é—´</button>
            </div>
        </div>

        <!-- æ¸¸æˆæ“ä½œ -->
        <div class="section">
            <h2>ğŸ® æ¸¸æˆæ“ä½œ</h2>
            <div class="grid">
                <div>
                    <p style="margin-bottom: 10px; color: #555; font-weight: 600;">è¿›æ”»æ–¹æ“ä½œ</p>
                    <div class="controls">
                        <button id="spawnBike" disabled>æ´¾ç”µåŠ¨è½¦(éæœºåŠ¨)</button>
                        <button id="spawnMotorcycle" disabled>æ´¾æ‘©æ‰˜è½¦(ä¸»é“)</button>
                    </div>
                </div>
                <div>
                    <p style="margin-bottom: 10px; color: #555; font-weight: 600;">é˜²å®ˆæ–¹æ“ä½œ</p>
                    <div class="controls">
                        <button id="placeAuxiliary" disabled>æ”¾ç½®è¾…è­¦</button>
                        <button id="placeTraffic" disabled>æ”¾ç½®äº¤è­¦</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="section">
            <h2>ğŸ“‹ æ§åˆ¶å°æ—¥å¿—</h2>
            <div class="log" id="logContainer"></div>
        </div>
    </div>

    <script type="module">
        // æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æµ‹è¯•å®¢æˆ·ç«¯
        // å®é™…ä½¿ç”¨æ—¶éœ€è¦å¯¼å…¥å®Œæ•´çš„ NetworkGameClient
        
        const log = (message, type = 'info') => {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        };

        const updateStatus = (field, value) => {
            document.getElementById(field).textContent = value;
        };

        // WebSocket å®¢æˆ·ç«¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
        let ws = null;
        let clientState = {
            connected: false,
            roomId: null,
            playerId: null,
            role: null
        };

        // è¿æ¥æŒ‰é’®
        document.getElementById('connectBtn').addEventListener('click', () => {
            try {
                ws = new WebSocket('ws://localhost:8080');
                
                ws.onopen = () => {
                    log('âœ“ æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨', 'success');
                    clientState.connected = true;
                    updateStatus('connectionStatus', 'å·²è¿æ¥');
                    document.getElementById('connectionStatus').className = 'status-value connected';
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('createAttackerBtn').disabled = false;
                    document.getElementById('createDefenderBtn').disabled = false;
                    document.getElementById('joinAttackerBtn').disabled = false;
                    document.getElementById('joinDefenderBtn').disabled = false;
                };

                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    log(`â† æ”¶åˆ°æ¶ˆæ¯: ${message.type}`, 'info');
                    handleMessage(message);
                };

                ws.onclose = () => {
                    log('âœ— ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥', 'error');
                    clientState.connected = false;
                    updateStatus('connectionStatus', 'æœªè¿æ¥');
                    document.getElementById('connectionStatus').className = 'status-value disconnected';
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    disableAllGameButtons();
                };

                ws.onerror = (error) => {
                    log('âœ— WebSocket é”™è¯¯', 'error');
                    console.error(error);
                };
            } catch (error) {
                log(`âœ— è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        });

        // æ–­å¼€è¿æ¥
        document.getElementById('disconnectBtn').addEventListener('click', () => {
            if (ws) {
                ws.close();
            }
        });

        // å‘é€æ¶ˆæ¯
        const sendMessage = (message) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                message.timestamp = Date.now();
                ws.send(JSON.stringify(message));
                log(`â†’ å‘é€æ¶ˆæ¯: ${message.type}`, 'info');
            } else {
                log('âœ— æœªè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            }
        };

        // å¤„ç†æ¶ˆæ¯
        const handleMessage = (message) => {
            switch (message.type) {
                case 'CREATE_ROOM':
                case 'JOIN_ROOM':
                    clientState.roomId = message.roomId;
                    clientState.playerId = message.playerId;
                    updateStatus('roomId', message.roomId);
                    updateStatus('playerId', message.playerId);
                    log(`âœ“ æˆ¿é—´ID: ${message.roomId}`, 'success');
                    
                    // å¯ç”¨æ¸¸æˆæ§åˆ¶
                    document.getElementById('readyBtn').disabled = false;
                    document.getElementById('leaveBtn').disabled = false;
                    break;

                case 'GAME_START':
                    log('âœ“ æ¸¸æˆå¼€å§‹ï¼', 'success');
                    enableGameButtons();
                    break;

                case 'GAME_STATE_UPDATE':
                    // æ˜¾ç¤ºæ¸¸æˆçŠ¶æ€
                    const state = message.state;
                    log(`çŠ¶æ€: é¢„ç®—=${clientState.role === 'ATTACKER' ? state.attackerBudget : state.defenderBudget}, è½¦è¾†=${state.vehicles.length}, å•ä½=${state.defenseUnits.length}`);
                    break;

                case 'GAME_OVER':
                    log(`âœ“ æ¸¸æˆç»“æŸï¼èƒœè€…: ${message.winner}`, 'success');
                    log(`åŸå› : ${message.reason}`, 'info');
                    disableAllGameButtons();
                    break;

                case 'ERROR':
                    log(`âœ— é”™è¯¯: ${message.message}`, 'error');
                    break;
            }
        };

        // åˆ›å»ºæˆ¿é—´ï¼ˆè¿›æ”»æ–¹ï¼‰
        document.getElementById('createAttackerBtn').addEventListener('click', () => {
            const playerName = document.getElementById('playerName1').value || 'æµ‹è¯•ç©å®¶1';
            clientState.role = 'ATTACKER';
            updateStatus('role', 'è¿›æ”»æ–¹');
            sendMessage({
                type: 'CREATE_ROOM',
                playerName: playerName,
                role: 'ATTACKER'
            });
        });

        // åˆ›å»ºæˆ¿é—´ï¼ˆé˜²å®ˆæ–¹ï¼‰
        document.getElementById('createDefenderBtn').addEventListener('click', () => {
            const playerName = document.getElementById('playerName1').value || 'æµ‹è¯•ç©å®¶1';
            clientState.role = 'DEFENDER';
            updateStatus('role', 'é˜²å®ˆæ–¹');
            sendMessage({
                type: 'CREATE_ROOM',
                playerName: playerName,
                role: 'DEFENDER'
            });
        });

        // åŠ å…¥æˆ¿é—´ï¼ˆè¿›æ”»æ–¹ï¼‰
        document.getElementById('joinAttackerBtn').addEventListener('click', () => {
            const roomId = document.getElementById('joinRoomId').value;
            const playerName = document.getElementById('playerName2').value || 'æµ‹è¯•ç©å®¶2';
            if (!roomId) {
                log('âœ— è¯·è¾“å…¥æˆ¿é—´ID', 'error');
                return;
            }
            clientState.role = 'ATTACKER';
            updateStatus('role', 'è¿›æ”»æ–¹');
            sendMessage({
                type: 'JOIN_ROOM',
                roomId: roomId,
                playerName: playerName,
                role: 'ATTACKER'
            });
        });

        // åŠ å…¥æˆ¿é—´ï¼ˆé˜²å®ˆæ–¹ï¼‰
        document.getElementById('joinDefenderBtn').addEventListener('click', () => {
            const roomId = document.getElementById('joinRoomId').value;
            const playerName = document.getElementById('playerName2').value || 'æµ‹è¯•ç©å®¶2';
            if (!roomId) {
                log('âœ— è¯·è¾“å…¥æˆ¿é—´ID', 'error');
                return;
            }
            clientState.role = 'DEFENDER';
            updateStatus('role', 'é˜²å®ˆæ–¹');
            sendMessage({
                type: 'JOIN_ROOM',
                roomId: roomId,
                playerName: playerName,
                role: 'DEFENDER'
            });
        });

        // å‡†å¤‡
        document.getElementById('readyBtn').addEventListener('click', () => {
            sendMessage({
                type: 'PLAYER_READY',
                ready: true
            });
            log('âœ“ å·²è®¾ç½®ä¸ºå‡†å¤‡çŠ¶æ€', 'success');
        });

        // ç¦»å¼€æˆ¿é—´
        document.getElementById('leaveBtn').addEventListener('click', () => {
            sendMessage({
                type: 'LEAVE_ROOM',
                roomId: clientState.roomId
            });
            clientState.roomId = null;
            clientState.playerId = null;
            clientState.role = null;
            updateStatus('roomId', '-');
            updateStatus('playerId', '-');
            updateStatus('role', '-');
            disableAllGameButtons();
        });

        // æ´¾å‡ºç”µåŠ¨è‡ªè¡Œè½¦
        document.getElementById('spawnBike').addEventListener('click', () => {
            sendMessage({
                type: 'SPAWN_VEHICLE',
                vehicleType: 'ELECTRIC_BIKE',
                lane: 'NON_MOTORIZED'
            });
        });

        // æ´¾å‡ºæ‘©æ‰˜è½¦
        document.getElementById('spawnMotorcycle').addEventListener('click', () => {
            sendMessage({
                type: 'SPAWN_VEHICLE',
                vehicleType: 'MOTORCYCLE_WITH_PERMIT',
                lane: 'MAIN_ROAD'
            });
        });

        // æ”¾ç½®è¾…è­¦
        document.getElementById('placeAuxiliary').addEventListener('click', () => {
            const x = Math.floor(Math.random() * 12);
            const y = Math.floor(Math.random() * 8);
            sendMessage({
                type: 'PLACE_DEFENSE',
                unitType: 'AUXILIARY',
                position: { x, y }
            });
        });

        // æ”¾ç½®äº¤è­¦
        document.getElementById('placeTraffic').addEventListener('click', () => {
            const x = Math.floor(Math.random() * 12);
            const y = Math.floor(Math.random() * 8);
            sendMessage({
                type: 'PLACE_DEFENSE',
                unitType: 'TRAFFIC',
                position: { x, y }
            });
        });

        const enableGameButtons = () => {
            if (clientState.role === 'ATTACKER') {
                document.getElementById('spawnBike').disabled = false;
                document.getElementById('spawnMotorcycle').disabled = false;
            } else if (clientState.role === 'DEFENDER') {
                document.getElementById('placeAuxiliary').disabled = false;
                document.getElementById('placeTraffic').disabled = false;
            }
        };

        const disableAllGameButtons = () => {
            document.getElementById('spawnBike').disabled = true;
            document.getElementById('spawnMotorcycle').disabled = true;
            document.getElementById('placeAuxiliary').disabled = true;
            document.getElementById('placeTraffic').disabled = true;
            document.getElementById('readyBtn').disabled = true;
            document.getElementById('leaveBtn').disabled = true;
            document.getElementById('createAttackerBtn').disabled = true;
            document.getElementById('createDefenderBtn').disabled = true;
            document.getElementById('joinAttackerBtn').disabled = true;
            document.getElementById('joinDefenderBtn').disabled = true;
        };

        // åˆå§‹åŒ–æ—¥å¿—
        log('ç½‘ç»œå¯¹æˆ˜æ¸¸æˆæµ‹è¯•å®¢æˆ·ç«¯å·²å¯åŠ¨', 'success');
        log('è¯·å…ˆç‚¹å‡»"è¿æ¥æœåŠ¡å™¨"æŒ‰é’®', 'info');
    </script>
</body>
</html>
